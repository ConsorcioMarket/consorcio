// Prisma Schema for Cons√≥rcio Market

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
}

enum PJStatus {
  INCOMPLETE
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum CotaStatus {
  AVAILABLE
  RESERVED
  SOLD
  REMOVED
}

enum ProposalStatus {
  UNDER_REVIEW
  PRE_APPROVED
  APPROVED
  TRANSFER_STARTED
  COMPLETED
  REJECTED
}

enum DocumentStatus {
  PENDING_UPLOAD
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum OwnerType {
  PF
  PJ
  COTA
}

enum BuyerType {
  PF
  PJ
}

enum DocumentType {
  PF_RG
  PF_CPF
  PF_BIRTH_CERTIFICATE
  PF_INCOME_TAX
  PF_EXTRA
  PJ_ARTICLES_OF_INCORPORATION
  PJ_PROOF_OF_ADDRESS
  PJ_DRE
  PJ_STATEMENT
  PJ_EXTRA
  COTA_STATEMENT
}

// ============================================
// MODELS
// ============================================

model ProfilePF {
  id                   String   @id @default(uuid())
  email                String   @default("")
  fullName             String   @map("full_name")
  cpf                  String?
  phone                String?
  role                 UserRole @default(USER)
  addressStreet        String?  @map("address_street")
  addressNumber        String?  @map("address_number")
  addressComplement    String?  @map("address_complement")
  addressNeighborhood  String?  @map("address_neighborhood")
  addressCity          String?  @map("address_city")
  addressState         String?  @map("address_state")
  addressZip           String?  @map("address_zip")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  profilesPJ           ProfilePJ[]
  cotasAsSeller        Cota[]            @relation("SellerCotas")
  proposalsAsBuyer     Proposal[]        @relation("BuyerProposals")
  documentsReviewed    Document[]        @relation("DocumentReviewer")
  proposalHistoryChanges ProposalHistory[] @relation("ProposalHistoryChanger")
  cotaHistoryChanges   CotaHistory[]     @relation("CotaHistoryChanger")

  @@map("profiles_pf")
}

model ProfilePJ {
  id                   String    @id @default(uuid())
  pfId                 String    @map("pf_id")
  legalName            String    @map("legal_name")
  cnpj                 String    @unique
  companyEmail         String?   @map("company_email")
  companyPhone         String?   @map("company_phone")
  addressStreet        String?   @map("address_street")
  addressNumber        String?   @map("address_number")
  addressComplement    String?   @map("address_complement")
  addressNeighborhood  String?   @map("address_neighborhood")
  addressCity          String?   @map("address_city")
  addressState         String?   @map("address_state")
  addressZip           String?   @map("address_zip")
  status               PJStatus  @default(INCOMPLETE)
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  profilePF            ProfilePF @relation(fields: [pfId], references: [id], onDelete: Cascade)

  @@map("profiles_pj")
}

model Cota {
  id                  String      @id @default(uuid())
  sellerId            String      @map("seller_id")
  administrator       String
  creditAmount        Decimal     @map("credit_amount") @db.Decimal(15, 2)
  outstandingBalance  Decimal     @map("outstanding_balance") @db.Decimal(15, 2)
  nInstallments       Int         @map("n_installments")
  installmentValue    Decimal     @map("installment_value") @db.Decimal(15, 2)
  entryAmount         Decimal     @map("entry_amount") @db.Decimal(15, 2)
  entryPercentage     Decimal     @map("entry_percentage") @db.Decimal(5, 2)
  monthlyRate         Decimal?    @map("monthly_rate") @db.Decimal(6, 4)
  status              CotaStatus  @default(AVAILABLE)
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  seller              ProfilePF   @relation("SellerCotas", fields: [sellerId], references: [id], onDelete: Cascade)
  proposals           Proposal[]
  cotaHistory         CotaHistory[]

  @@index([sellerId])
  @@index([status])
  @@index([administrator])
  @@index([creditAmount])
  @@index([entryPercentage])
  @@map("cotas")
}

model Proposal {
  id                String          @id @default(uuid())
  cotaId            String          @map("cota_id")
  buyerPfId         String          @map("buyer_pf_id")
  buyerType         BuyerType       @map("buyer_type")
  buyerEntityId     String          @map("buyer_entity_id")
  groupId           String?         @map("group_id")
  status            ProposalStatus  @default(UNDER_REVIEW)
  rejectionReason   String?         @map("rejection_reason")
  transferFee       Decimal?        @map("transfer_fee") @db.Decimal(15, 2)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  cota              Cota            @relation(fields: [cotaId], references: [id], onDelete: Cascade)
  buyerPf           ProfilePF       @relation("BuyerProposals", fields: [buyerPfId], references: [id], onDelete: Cascade)
  proposalHistory   ProposalHistory[]

  @@index([cotaId])
  @@index([buyerPfId])
  @@index([groupId])
  @@index([status])
  @@map("proposals")
}

model Document {
  id                String          @id @default(uuid())
  ownerId           String          @map("owner_id")
  ownerType         OwnerType       @map("owner_type")
  documentType      DocumentType    @map("document_type")
  fileUrl           String          @map("file_url")
  fileName          String          @map("file_name")
  status            DocumentStatus  @default(PENDING_UPLOAD)
  reviewedBy        String?         @map("reviewed_by")
  reviewedAt        DateTime?       @map("reviewed_at")
  rejectionReason   String?         @map("rejection_reason")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  reviewer          ProfilePF?      @relation("DocumentReviewer", fields: [reviewedBy], references: [id])

  @@index([ownerId, ownerType])
  @@index([status])
  @@map("documents")
}

model ProposalHistory {
  id          String          @id @default(uuid())
  proposalId  String          @map("proposal_id")
  oldStatus   ProposalStatus? @map("old_status")
  newStatus   ProposalStatus  @map("new_status")
  changedBy   String?         @map("changed_by")
  notes       String?
  changedAt   DateTime        @default(now()) @map("changed_at")

  // Relations
  proposal    Proposal        @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  changer     ProfilePF?      @relation("ProposalHistoryChanger", fields: [changedBy], references: [id])

  @@index([proposalId])
  @@map("proposal_history")
}

model CotaHistory {
  id            String    @id @default(uuid())
  cotaId        String    @map("cota_id")
  fieldChanged  String    @map("field_changed")
  oldValue      String?   @map("old_value")
  newValue      String?   @map("new_value")
  changedBy     String?   @map("changed_by")
  changedAt     DateTime  @default(now()) @map("changed_at")

  // Relations
  cota          Cota      @relation(fields: [cotaId], references: [id], onDelete: Cascade)
  changer       ProfilePF? @relation("CotaHistoryChanger", fields: [changedBy], references: [id])

  @@index([cotaId])
  @@map("cota_history")
}
